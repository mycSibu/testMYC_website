<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>多用途礼堂场地预订</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'myc-deep': '#5B217D',
                        'myc-green': '#68b92b',
                        'myc-yellow': '#FFC107',
                        'myc-light-purple': '#936CA3',
                        'myc-offwhite': '#F9F7F3',
                        'myc-dark-footer': '#3A1054',
                    },
                },
            },
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .shadow-3xl {
            box-shadow: 0 25px 50px -12px rgba(90, 46, 130, 0.35);
        }

        /* === 表格样式（紧凑 + 内部滚动） === */
        .table-container {
            max-height: 340px;
            overflow-y: auto;
            overflow-x: hidden;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
        }

        .grid-header {
            background-color: #5B217D;
            color: #ffffff;
            font-size: 12px;
            font-weight: 600;
            padding: 6px 8px;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .time-header {
            background-color: #f3f4f6;
            color: #374151;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 6px;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 40px;
        }

        .slot-cell {
            font-size: 12px;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 3px 4px;
            height: 40px;
        }
    </style>

    <!-- 核心逻辑脚本 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import {
            getDatabase,
            ref,
            onValue,
            get,
            update,
            push
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDLY-Nd3exPFG2ExPil-ko_dFn9Zz3E-oE",
            authDomain: "myc-booking.firebaseapp.com",
            databaseURL: "https://myc-booking-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "myc-booking",
            storageBucket: "myc-booking.firebasestorage.app",
            messagingSenderId: "398699322309",
            appId: "1:398699322309:web:2a176336e76eda30c009ac",
            measurementId: "G-MET5E50WKS",
        };

        const HOURLY_BLOCKS = [
            "08:00","09:00","10:00","11:00",
            "14:00","15:00",
            "16:00","17:00","18:00","19:00",
            "20:00","21:00","22:00"
        ];

        function getOpeningHours(date) {
            const day = date.getDay(); 
            let hours = { start: "00:00", end: "00:00", lunchStart: "12:00", lunchEnd: "14:00" };

            if (day >= 1 && day <= 6) {
                hours.start = "08:00";
                hours.end = "22:00";
            } else if (day === 0) {
                hours.start = "14:00";
                hours.end = "22:00";
            }
            hours.display = `${hours.start} – ${hours.end}（12:00–14:00 午休不开放）`;
            return hours;
        }

        function isTimeSlotOpen(date, time) {
            const day = date.getDay();
            const hour = parseInt(time.substring(0, 2), 10);

            if (day >= 1 && day <= 6) {
                return (hour >= 8 && hour <= 11) || (hour >= 14 && hour <= 21);
            } else if (day === 0) {
                return (hour >= 14 && hour <= 21);
            }
            return false;
        }

        const MAX_COURTS_IN_HALL = 4;

        const SPORTS = [
            "羽毛球 (Badminton)",
            "匹克球 (Pickleball)",
            "乒乓球 (Table Tennis)",
            "篮球 (Basketball)",
            "巧固球 (Tchoukball)",
            "队长球 (Captain Ball)",
        ];

        const BADMINTON_NAME   = "羽毛球 (Badminton)";
        const PINGPONG_NAME    = "乒乓球 (Table Tennis)";
        const PICKLEBALL_NAME  = "匹克球 (Pickleball)";
        const LARGE_FIELD_SPORTS = [
            "篮球 (Basketball)",
            "巧固球 (Tchoukball)",
            "队长球 (Captain Ball)",
        ];

        // 全局状态
        let app, db, auth;
        let userId = null;
        let selectedDate = new Date();
        let allCourtSlots = [];

        let isMember = false;
        let bookingWindowDays = 3;

        // DOM 引用
        const authStatusEl          = document.getElementById('auth-status');
        const membershipStatusEl    = document.getElementById('membership-status');
        const sportSelectEl         = document.getElementById('sport-select');
        const courtsCountLabelEl    = document.getElementById('courts-count-label');
        const courtsCountSelectEl   = document.getElementById('courts-count-select');
        const startTimeSelectEl     = document.getElementById('start-time-select');
        const durationSelectEl      = document.getElementById('duration-select');
        const dateSelectEl          = document.getElementById('date-select');
        const prevDayBtn            = document.getElementById('prev-day');
        const nextDayBtn            = document.getElementById('next-day');
        const currentDateDisplayEl  = document.getElementById('current-date-display');
        const slotsTableEl          = document.getElementById('slots-table');
        const messageBoxEl          = document.getElementById('message-box');
        const loadingIndicatorEl    = document.getElementById('loading-indicator');
        const bookButtonEl          = document.getElementById('book-button');
        const openingHoursDisplayEl = document.getElementById('opening-hours-display');

        const waitingListModal       = document.getElementById('booking-modal');
        const waitingListModalTitle  = document.querySelector('#booking-modal h3');
        const waitingListModalBody   = document.getElementById('modal-body');
        const waitingListConfirmBtn  = document.getElementById('confirm-booking-btn');
        const waitingListCloseBtn    = document.getElementById('close-modal-btn');

        let pendingAction = null;

        // 生成预订编号
        async function generateReservationIdForMonth(dateStr) {
            if (!db) {
                const fallback = 'BK' + dateStr.replace(/-/g, '').slice(2) + '-' + String(Math.floor(Math.random() * 99) + 1).padStart(2, '0');
                return fallback;
            }
            const d  = new Date(dateStr);
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yy = String(d.getFullYear()).slice(-2);
            let countThisMonth = 0;
            try {
                const snap = await get(ref(db, 'auditorium_reservations'));
                if (snap.exists()) {
                    const data = snap.val();
                    Object.values(data).forEach((item) => {
                        if (!item.date) return;
                        const rd = new Date(item.date);
                        if (rd.getFullYear() === d.getFullYear() && rd.getMonth() === d.getMonth()) {
                            countThisMonth++;
                        }
                    });
                }
            } catch (e) {
                console.error('读取预订计数失败:', e);
            }
            const seq = String(countThisMonth + 1).padStart(2, '0');
            return `BK${dd}${mm}${yy}-${seq}`;
        }

        // 工具函数
        function getTodayDateStr() {
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function formatDate(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function getHourIndex(time) {
            return HOURLY_BLOCKS.indexOf(time);
        }

        function isSlotTimeInPast(dateStr, time) {
            const now = new Date();
            // 确保日期字符串格式正确，且能被解析
            const slotDateTime = new Date(dateStr + 'T' + time + ':00');
            
            // 检查日期是否是今天，并且时间是否已过去
            if (dateStr === formatDate(now) && slotDateTime < now) {
                 return true;
            }
            // 如果不是今天，或者时间还没到，则不算过期
            return false;
        }

        function getMaxBookingDate() {
            const d = new Date();
            d.setDate(d.getDate() + bookingWindowDays);
            return d;
        }

        function getTimeRangeLabel(time) {
            const hour = parseInt(time.split(':')[0], 10);
            const nextHour = hour + 1;
            const nextTime = `${String(nextHour).padStart(2, '0')}:00`;
            return `${time} - ${nextTime}`;
        }

        function showMessage(message, type) {
            messageBoxEl.textContent = message;
            messageBoxEl.className = 'mt-6 p-4 rounded-lg text-center font-medium transition duration-300 ease-in-out';
            if (type === 'success') {
                messageBoxEl.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-200');
            } else if (type === 'error') {
                messageBoxEl.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-200');
            } else {
                messageBoxEl.classList.add('bg-yellow-50', 'text-yellow-800', 'border', 'border-yellow-200');
            }
            setTimeout(() => {
                messageBoxEl.textContent = '';
                messageBoxEl.className = 'mt-6 p-4 rounded-lg text-center font-medium transition duration-300 ease-in-out';
            }, 5000);
        }

        function withRetry(fn, retries = 3, delay = 500) {
            return new Promise((resolve, reject) => {
                const attempt = (n) => {
                    fn().then(resolve).catch((err) => {
                        if (n <= 0) return reject(err);
                        setTimeout(() => attempt(n - 1), delay);
                    });
                };
                attempt(retries);
            });
        }
        
        // --- Gemini API Call to simulate sending email ---
        async function sendWaitingListConfirmationEmail(details) {
            const userEmail = details.userEmail;
            const userName = details.userName;
            const prompt = `Write a confirmation email in Chinese (Mandarin) to a user named ${userName} (${userEmail}) confirming they have successfully been added to the Waiting List for a sports court booking at MY Centre Sibu.

Details:
- Sport: ${details.sport}
- Date: ${details.dateStr}
- Start Time: ${details.startTime}
- Duration: ${details.durationHours} hours
- Courts Requested: ${details.courtsCount}

The email should be professional yet friendly. It must state clearly:
1. The booking details (Sport, Date, Time, Courts).
2. They are on the waiting list and their request is logged.
3. Staff will contact them *prior* to the booking date (e.g., the day before) if a spot becomes available.
4. Provide a simple closing from 'MYC Admin Team'.

Format the response as plain text, starting with 'Subject: [MYC场地预订] 候补名单确认' followed by a newline, and then the email body.`;

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: "You are an automated email generator for a Malaysian community center." }]
                },
            };

            try {
                const response = await withRetry(() => fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }), 5, 1000);

                if (!response.ok) throw new Error(`API response status: ${response.status}`);

                const result = await response.json();
                const emailContent = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (emailContent) {
                    console.log(`--- 模拟发送候补确认邮件给 ${userEmail} ---`);
                    console.log(emailContent);
                    console.log('--- 邮件发送模拟结束 ---');
                } else {
                    console.error('API 返回结构异常，未能生成邮件内容。');
                }
            } catch (e) {
                console.error('调用 Gemini API 生成邮件失败:', e);
            }
        }
        // --- END Gemini API Call ---


        function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db  = getDatabase(app);
                auth = getAuth(app);
                authStatusEl.textContent = '正在检查登录状态...';
                initAuth();
            } catch (err) {
                console.error('Firebase 初始化失败:', err);
                authStatusEl.textContent = 'Firebase 初始化失败：' + err.message;
            }
        }

        function initAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user && !user.isAnonymous) {
                    userId = user.uid;
                    const displayName = user.displayName || (user.email ? user.email.split('@')[0] : '用户');
                    authStatusEl.textContent = `已登录：${displayName}，可以进行预订。`;
                    checkMembership(user);
                    setupListeners();
                } else {
                    userId = null;
                    authStatusEl.innerHTML = '您尚未登录，无法进行场地预订。 <a href="login.html" class="text-indigo-600 underline ml-1">前往登录页</a>';
                    membershipStatusEl.textContent = '（未登录状态，暂视为非会员，无法下单）';
                    bookingWindowDays = 3;
                    dateSelectEl.disabled = true;
                    sportSelectEl.disabled = true;
                    courtsCountSelectEl.disabled = true;
                    startTimeSelectEl.disabled = true;
                    durationSelectEl.disabled = true;
                    bookButtonEl.disabled = true;
                }
            });
        }

        function checkMembership(user) {
            const domain = user.email ? user.email.split('@')[1] : '';
            if (user.email && (domain.includes('mycentre') || domain.includes('myc') || domain.includes('methodist') || domain.includes('church'))) {
                isMember = true;
                bookingWindowDays = 7;
                membershipStatusEl.textContent = `会员身份：是（可提前 ${bookingWindowDays} 天预订）`;
            } else {
                isMember = false;
                bookingWindowDays = 3;
                membershipStatusEl.textContent = `会员身份：否（最多提前 ${bookingWindowDays} 天预订）`;
            }
            dateSelectEl.disabled = false;
            sportSelectEl.disabled = false;
            courtsCountSelectEl.disabled = false;
            startTimeSelectEl.disabled = false;
            durationSelectEl.disabled = false;
            bookButtonEl.disabled = false;
            updateUI();
            setupRealtimeListener();
        }

        function setupRealtimeListener() {
            const slotsRef = ref(db, 'auditorium_court_slots');
            onValue(slotsRef, (snapshot) => {
                const data = snapshot.val() || {};
                allCourtSlots = Object.keys(data).map((key) => ({ id: key, ...data[key] }));
                renderAvailabilityGrid();
            });
        }

        function canStartAtTime(date, time, durationHours) {
            const startIndex = getHourIndex(time);
            if (startIndex === -1) return false;
            for (let h = 0; h < durationHours; h++) {
                const hourIndex = startIndex + h;
                if (hourIndex >= HOURLY_BLOCKS.length - 1) return false;
                const t = HOURLY_BLOCKS[hourIndex];
                if (h > 0) {
                    const prevT = HOURLY_BLOCKS[hourIndex - 1];
                    const currHour = parseInt(t.split(':')[0], 10);
                    const prevHour = parseInt(prevT.split(':')[0], 10);
                    if (currHour - prevHour > 1) return false;
                }
                if (!isTimeSlotOpen(date, t)) return false;
            }
            return true;
        }

        function isBookingValidInAllTimeSlots(dateStr, startTime, durationHours, courtIndices, bookingSport, slotsData) {
            const startIndex = getHourIndex(startTime);
            for (let h = 0; h < durationHours; h++) {
                const hourIndex = startIndex + h;
                if (hourIndex >= HOURLY_BLOCKS.length - 1) return `预订时长超出营业时间范围。`;
                const time = HOURLY_BLOCKS[hourIndex];
                
                // 确保时间没有过期
                if (isSlotTimeInPast(dateStr, time)) return `PAST_TIME`;

                if (h > 0) {
                    const prevT = HOURLY_BLOCKS[hourIndex - 1];
                    const prevHour = parseInt(prevT.split(':')[0]);
                    const currHour = parseInt(time.split(':')[0]);
                    if (currHour - prevHour > 1) return `无法跨越休息时间预订。`;
                }
                if (!isTimeSlotOpen(new Date(dateStr), time)) return `${time} 不在今日营业时段内。`;

                for (const courtIndex of courtIndices) {
                    const key = `${dateStr}_${time}_${courtIndex}`;
                    if (slotsData[key]) {
                        const existingSport = slotsData[key].sport;
                        return `OCCUPIED:${existingSport}`;
                    }
                }
            }
            return true;
        }

        function countPickleballBookings(dateStr, time, slotsData) {
            let count = 0;
            for (let c = 1; c <= MAX_COURTS_IN_HALL; c++) {
                const key = `${dateStr}_${time}_${c}`;
                if (slotsData[key] && slotsData[key].sport === PICKLEBALL_NAME) {
                    count++;
                }
            }
            return count;
        }

        function determineCourtIndices(sport, courtsCount, dateStr, startTime, durationHours, slotsData) {
            const checkValidity = (indices) => isBookingValidInAllTimeSlots(dateStr, startTime, durationHours, indices, sport, slotsData) === true;

            if (sport === BADMINTON_NAME) {
                if (courtsCount === 1) {
                    if (checkValidity([1])) return [1];
                    if (checkValidity([4])) return [4];
                    return [];
                } else if (courtsCount === 2) {
                    return checkValidity([1, 4]) ? [1, 4] : [];
                }
            }
            if (LARGE_FIELD_SPORTS.includes(sport)) {
                if (courtsCount === 2) {
                    if (checkValidity([1, 2])) return [1, 2];
                    if (checkValidity([3, 4])) return [3, 4];
                    return [];
                }
                if (courtsCount === 4) {
                    return checkValidity([1, 2, 3, 4]) ? [1, 2, 3, 4] : [];
                }
            }
            const targetIndices = [];
            for (let c = 1; c <= MAX_COURTS_IN_HALL; c++) {
                if (checkValidity([c])) {
                    targetIndices.push(c);
                    if (targetIndices.length === courtsCount) return targetIndices;
                }
            }
            return [];
        }

        function getAffectedSlotKeys(dateStr, startTime, durationHours, courtIndices) {
            const keys = [];
            const startIndex = getHourIndex(startTime);
            if (startIndex === -1) return keys;
            for (let h = 0; h < durationHours; h++) {
                const hourIndex = startIndex + h;
                if (hourIndex >= HOURLY_BLOCKS.length - 1) break;
                const time = HOURLY_BLOCKS[hourIndex];
                courtIndices.forEach((courtIndex) => {
                    keys.push(`${dateStr}_${time}_${courtIndex}`);
                });
            }
            return keys;
        }

        function getPreviousDay(dateStr) {
            const d = new Date(dateStr);
            d.setDate(d.getDate() - 1);
            return formatDate(d);
        }

        // --- 候补名单 (Waiting List) 显示逻辑 ---
        function showWaitingListModal(details) {
            pendingAction = { type: 'waiting', payload: details };

            waitingListModalTitle.textContent = "加入候补名单 (Waiting List)";
            
            // 通用文案
            let reasonText = "该时段的场地已满，暂时无法满足您的预订需求。";
            if (details.sport === PICKLEBALL_NAME && details.reason === 'quota_full') {
                 reasonText = "该时段的匹克球场地配额 (2个) 已满。";
            }

            waitingListModalBody.innerHTML = `
                <p class="text-red-600 font-medium">${reasonText}</p>
                <p class="font-bold text-myc-deep mt-3">您是否要加入候补名单？</p>
                <p class="text-sm text-gray-500 mt-2">
                    加入后，如果前一天 (${getPreviousDay(details.dateStr)}) 该时段有场地被释放或配额更新，
                    工作人员将优先联系您进行安排。
                </p>
                <div class="mt-4 p-3 bg-gray-50 rounded text-sm border border-gray-200">
                    <p><strong>运动:</strong> ${details.sport}</p>
                    <p><strong>日期:</strong> ${details.dateStr}</p>
                    <p><strong>时间:</strong> ${details.startTime} (${details.durationHours} 小时)</p>
                    <p><strong>需求:</strong> ${details.courtsCount} 个场地</p>
                </div>
            `;

            waitingListConfirmBtn.textContent = "确认加入候补";
            waitingListConfirmBtn.onclick = confirmWaitingList;
            waitingListModal.classList.remove('hidden');
        }

        async function confirmWaitingList() {
            if (!pendingAction || pendingAction.type !== 'waiting') return;
            
            const user = auth.currentUser;
            const details = pendingAction.payload;

            try {
                waitingListConfirmBtn.disabled = true;
                waitingListConfirmBtn.textContent = "提交中...";
                
                const { sport, dateStr, startTime, durationHours, courtsCount } = details;

                const wlRef = ref(db, 'auditorium_waiting_list');
                const newEntryRef = push(wlRef);
                await withRetry(() =>
                    update(newEntryRef, {
                        userId,
                        sport,
                        date: dateStr,
                        startTime,
                        durationHours,
                        courtsCount,
                        createdAt: Date.now(),
                        status: 'pending',
                        userEmail: user.email || 'unknown',
                        userName: user.displayName || 'unknown'
                    })
                );

                // --- NEW: Simulate sending confirmation email ---
                await sendWaitingListConfirmationEmail({
                    ...details,
                    userEmail: user.email,
                    userName: user.displayName || user.email.split('@')[0]
                });

                showMessage('已成功加入候补名单！如有空缺我们将通知您。并已发送邮件确认。', 'success');
            } catch (err) {
                console.error('加入候补失败:', err);
                showMessage('加入候补失败，请稍后重试。', 'error');
            } finally {
                waitingListConfirmBtn.disabled = false;
                waitingListModal.classList.add('hidden');
                pendingAction = null;
            }
        }

        waitingListCloseBtn.addEventListener('click', () => {
            waitingListModal.classList.add('hidden');
            pendingAction = null;
        });

        const COURT_LABELS = { 1: 'Court A', 2: 'Court B', 3: 'Court C', 4: 'Court D' };

        function getHourlyRate(sport, courtsCount, isMember) {
            if (LARGE_FIELD_SPORTS.includes(sport)) {
                if (courtsCount === 4) return isMember ? 60 : 80;
                if (courtsCount === 2) return isMember ? 30 : 40;
                return isMember ? 30 : 40;
            }
            if (sport === BADMINTON_NAME || sport === PICKLEBALL_NAME || sport === PINGPONG_NAME) {
                const perCourt = isMember ? 15 : 20;
                return perCourt * courtsCount;
            }
            const perCourt = isMember ? 15 : 20;
            return perCourt * courtsCount;
        }

        // --- 核心预订逻辑 ---
        async function attemptBooking() {
            if (!userId) {
                showMessage('请先完成登录再进行预订。', 'error');
                return;
            }

            const dateStr = dateSelectEl.value || formatDate(selectedDate);
            const sport = sportSelectEl.value;
            const courtsCount = parseInt(courtsCountSelectEl.value, 10);
            const startTime = startTimeSelectEl.value;
            const durationHours = parseInt(durationSelectEl.value, 10);

            if (isSlotTimeInPast(dateStr, startTime)) {
                showMessage('预订失败：您选择的开始时间已过期。', 'error');
                loadingIndicatorEl.classList.add('hidden');
                bookButtonEl.disabled = false;
                return;
            }

            if (!dateStr || !sport || !startTime || !durationHours || !courtsCount) {
                showMessage('请先完整选择日期、运动、时长和场地数。', 'error');
                return;
            }

            const date = new Date(dateStr);
            if (!canStartAtTime(date, startTime, durationHours)) {
                showMessage('所选时段已超出营业时间或跨越午休，无法连续预订。', 'error');
                return;
            }

            bookButtonEl.disabled = true;
            loadingIndicatorEl.classList.remove('hidden');

            try {
                // 1. 读取最新场地数据
                const slotsSnap = await get(ref(db, 'auditorium_court_slots'));
                const slotsData = slotsSnap.exists() ? slotsSnap.val() : {};

                // 2. 尝试寻找可用场地
                const courtIndicesToBook = determineCourtIndices(sport, courtsCount, dateStr, startTime, durationHours, slotsData);
                
                // 2.5 再次检查是否在预订时段内出现过期时间
                const validityCheck = isBookingValidInAllTimeSlots(dateStr, startTime, durationHours, courtIndicesToBook, sport, slotsData);
                if (validityCheck === 'PAST_TIME') {
                    throw new Error('预订失败：部分预订时段已过期。');
                }

                // 3. 特殊检查：匹克球配额 (最多 2 场)
                let isPickleballQuotaFull = false;
                if (sport === PICKLEBALL_NAME) {
                    const startIndex = getHourIndex(startTime);
                    for (let h = 0; h < durationHours; h++) {
                        const time = HOURLY_BLOCKS[startIndex + h];
                        if (countPickleballBookings(dateStr, time, slotsData) >= 2) {
                            isPickleballQuotaFull = true;
                            break;
                        }
                    }
                }

                // 4. 判断是否需要进入候补名单
                // 情况A: 匹克球配额满了
                // 情况B: 找不到足够的空闲场地 (courtIndicesToBook 数量不对)
                if (isPickleballQuotaFull || courtIndicesToBook.length !== courtsCount) {
                    showWaitingListModal({
                        sport,
                        dateStr,
                        startTime,
                        durationHours,
                        courtsCount,
                        reason: isPickleballQuotaFull ? 'quota_full' : 'no_slots'
                    });
                    
                    // 停止后续预订流程
                    loadingIndicatorEl.classList.add('hidden');
                    bookButtonEl.disabled = false;
                    return; 
                }

                // 5. 再次确认这些格子真的没被抢 (Double Check)
                const requestedSlotKeys = getAffectedSlotKeys(dateStr, startTime, durationHours, courtIndicesToBook);
                for (const slotKey of requestedSlotKeys) {
                    if (slotsData[slotKey]) {
                        throw new Error(`预订失败：场地刚刚被别人抢先预订了。`);
                    }
                }

                // 6. 执行预订写入
                const now = Date.now();
                const reservationId = await generateReservationIdForMonth(dateStr);
                const updates = {};

                requestedSlotKeys.forEach((slotKey) => {
                    updates[slotKey] = {
                        userId,
                        sport,
                        date: dateStr,
                        time: slotKey.split('_')[1],
                        courtIndex: parseInt(slotKey.split('_')[2], 10),
                        reservationId,
                        timestamp: now,
                    };
                });

                await withRetry(() => update(ref(db, 'auditorium_court_slots'), updates));

                const reservationSummaryRef = ref(db, `auditorium_reservations/${reservationId}`);
                await withRetry(() => update(reservationSummaryRef, {
                    reservationId,
                    userId,
                    sport,
                    date: dateStr,
                    startTime,
                    durationHours,
                    courtsCount,
                    createdAt: now,
                }));

                // 7. 跳转付款
                const hourlyRate = getHourlyRate(sport, courtsCount, isMember);
                const totalAmount = hourlyRate * durationHours;
                const user = auth.currentUser;
                
                const bookingSummary = {
                    reservationId,
                    sport,
                    date: dateStr,
                    startTime,
                    durationHours,
                    courtsCount,
                    courts: courtIndicesToBook.map(i => COURT_LABELS[i] || ('Court ' + i)),
                    isMember,
                    hourlyRate,
                    totalAmount,
                    userName: user.displayName || '用户',
                    email: user.email,
                    createdAt: now,
                    slotKeys: requestedSlotKeys,
                };

                localStorage.setItem('myc_latest_booking', JSON.stringify(bookingSummary));
                window.location.href = 'payment.html';

            } catch (err) {
                console.error('预订失败:', err);
                showMessage(`预订失败: ${err.message}`, 'error');
            } finally {
                loadingIndicatorEl.classList.add('hidden');
                bookButtonEl.disabled = false;
            }
        }

        function updateStartTimeOptions() {
            const date = new Date(dateSelectEl.value);
            const durationHours = parseInt(durationSelectEl.value, 10) || 1;
            const availableStartTimes = HOURLY_BLOCKS.slice(0, -1).filter((time) => {
                // 确保时间没有过期
                if (isSlotTimeInPast(formatDate(date), time)) return false; 
                return canStartAtTime(date, time, durationHours);
            });
            
            startTimeSelectEl.innerHTML = availableStartTimes.map((t) => `<option value="${t}">${t}</option>`).join('');
            
            // 如果所有时段都过期或被占用，则可能需要禁用预订按钮
            bookButtonEl.disabled = availableStartTimes.length === 0;

            const hoursInfo = getOpeningHours(date);
            openingHoursDisplayEl.textContent = `今日开放时间: ${hoursInfo.display}`;
        }

        function updateCourtCountSelector() {
            const selectedSport = sportSelectEl.value;
            courtsCountSelectEl.innerHTML = '';
            if (LARGE_FIELD_SPORTS.includes(selectedSport)) {
                courtsCountLabelEl.textContent = '场地选择 (半场/全场)';
                courtsCountSelectEl.innerHTML = `
                    <option value="2">半场 1 (Court A + B)</option>
                    <option value="2">半场 2 (Court C + D)</option>
                    <option value="4">全场 (Court A ~ D)</option>
                `;
            } else if (selectedSport === BADMINTON_NAME) {
                courtsCountLabelEl.textContent = '场地数 (自动分配 A/D)';
                courtsCountSelectEl.innerHTML = `
                    <option value="1">1 个场地 (A 或 D)</option>
                    <option value="2">2 个场地 (A 和 D)</option>
                `;
            } else {
                courtsCountLabelEl.textContent = '场地数 (最多 2 场)';
                courtsCountSelectEl.innerHTML = `
                    <option value="1">1 个场地</option>
                    <option value="2">2 个场地</option>
                `;
            }
            updateStartTimeOptions();
            renderAvailabilityGrid();
        }

        function renderAvailabilityGrid() {
            const dateStr = formatDate(selectedDate);
            currentDateDisplayEl.textContent = `${dateStr} - 场地实时可用性 (Court A–D)`;
            while (slotsTableEl.children.length > 5) {
                slotsTableEl.removeChild(slotsTableEl.lastChild);
            }
            const selectedSport = sportSelectEl.value;
            const durationHours = parseInt(durationSelectEl.value, 10) || 1;
            const date = new Date(dateStr);
            const slotsData = allCourtSlots.reduce((acc, s) => {
                const key = `${s.date}_${s.time}_${s.courtIndex}`;
                acc[key] = s;
                return acc;
            }, {});

            HOURLY_BLOCKS.slice(0, -1).forEach((time) => {
                const isPast = isSlotTimeInPast(dateStr, time); // 检查是否过期
                const canStartHere = canStartAtTime(date, time, durationHours);
                
                const timeHeaderEl = document.createElement('div');
                timeHeaderEl.className = 'time-header';
                timeHeaderEl.textContent = getTimeRangeLabel(time);

                // 如果时段过期或不在营业时间，则标记时间头
                if (isPast || !canStartHere) {
                    timeHeaderEl.classList.add('bg-gray-300', 'text-gray-500');
                }
                slotsTableEl.appendChild(timeHeaderEl);

                for (let c = 1; c <= MAX_COURTS_IN_HALL; c++) {
                    const cellEl = document.createElement('div');
                    cellEl.className = 'slot-cell';
                    const key = `${dateStr}_${time}_${c}`;
                    const slot = slotsData[key];

                    if (isPast) { // NEW: 如果时段已过期，则直接锁定格子
                        cellEl.classList.add('bg-gray-400', 'text-white');
                        cellEl.style.cursor = 'default';
                        cellEl.innerHTML = '已过期';
                    } else if (slot) {
                        const shortSport = slot.sport.replace(/\s*\(.*\)/, '');
                        cellEl.classList.add('bg-red-500', 'text-white', 'shadow-inner');
                        cellEl.style.cursor = 'default';
                        cellEl.innerHTML = `已预订<span class="text-[10px] opacity-75">(${shortSport})</span>`;
                    } else {
                        if (selectedSport === BADMINTON_NAME && c !== 1 && c !== 4) {
                            cellEl.classList.add('bg-gray-100', 'text-gray-500');
                            cellEl.style.cursor = 'default';
                            cellEl.innerHTML = '羽毛球限 A/D';
                        } else {
                            const pbCount = countPickleballBookings(dateStr, time, slotsData);
                            if (selectedSport === PICKLEBALL_NAME && pbCount >= 2) {
                                cellEl.classList.add('bg-yellow-100', 'text-yellow-800');
                                cellEl.style.cursor = 'default';
                                cellEl.innerHTML = '配额满 (可候补)';
                            } else {
                                cellEl.classList.add('bg-green-500', 'text-white');
                                cellEl.style.cursor = 'default';
                                cellEl.innerHTML = '可预订';
                            }
                        }
                    }
                    slotsTableEl.appendChild(cellEl);
                }
            });
        }

        function updateUI() {
            const todayStr = getTodayDateStr();
            const maxDateStr = formatDate(getMaxBookingDate());
            dateSelectEl.min = todayStr;
            dateSelectEl.max = maxDateStr;
            dateSelectEl.value = formatDate(selectedDate);
            prevDayBtn.disabled = formatDate(selectedDate) <= todayStr;
            nextDayBtn.disabled = formatDate(selectedDate) >= maxDateStr;
            updateStartTimeOptions();
            renderAvailabilityGrid();
        }

        function setupListeners() {
            SPORTS.forEach((sport) => {
                const opt = document.createElement('option');
                opt.value = sport;
                opt.textContent = sport;
                sportSelectEl.appendChild(opt);
            });
            sportSelectEl.value = BADMINTON_NAME;
            dateSelectEl.value = formatDate(selectedDate);

            prevDayBtn.addEventListener('click', () => {
                const todayStr = getTodayDateStr();
                if (formatDate(selectedDate) <= todayStr) return;
                selectedDate.setDate(selectedDate.getDate() - 1);
                dateSelectEl.value = formatDate(selectedDate);
                updateUI();
            });

            nextDayBtn.addEventListener('click', () => {
                const maxDate = getMaxBookingDate();
                if (formatDate(selectedDate) >= formatDate(maxDate)) {
                    showMessage(isMember ? '会员最多可提前 7 天预订。' : '非会员最多可提前 3 天预订。', 'error');
                    return;
                }
                selectedDate.setDate(selectedDate.getDate() + 1);
                dateSelectEl.value = formatDate(selectedDate);
                updateUI();
            });

            dateSelectEl.addEventListener('change', () => {
                const newDate = new Date(dateSelectEl.value);
                const todayStr = getTodayDateStr();
                const maxDateStr = formatDate(getMaxBookingDate());
                if (formatDate(newDate) < todayStr || formatDate(newDate) > maxDateStr) {
                    showMessage('日期超出允许范围', 'error');
                    dateSelectEl.value = formatDate(selectedDate);
                    return;
                }
                selectedDate = newDate;
                updateUI();
            });

            sportSelectEl.addEventListener('change', updateCourtCountSelector);
            courtsCountSelectEl.addEventListener('change', renderAvailabilityGrid);
            durationSelectEl.addEventListener('change', () => { updateStartTimeOptions(); renderAvailabilityGrid(); });
            startTimeSelectEl.addEventListener('change', renderAvailabilityGrid);
            bookButtonEl.addEventListener('click', attemptBooking);
            updateCourtCountSelector();
        }

        window.onload = function () {
            selectedDate = new Date(getTodayDateStr());
            initFirebase();
        };
    </script>
</head>

<body class="min-h-screen p-4 bg-myc-offwhite">
    <div id="message-box" class="fixed top-0 left-1/2 transform -translate-x-1/2 z-50 p-4"></div>

    <div id="app" class="max-w-6xl mx-auto bg-white shadow-3xl rounded-xl p-6 md:p-10 border border-gray-100">
        <!-- 顶部返回条 + 标题区 -->
        <div class="mb-6 flex flex-col gap-3">
            <a
                href="myc_homepage.html"
                class="inline-flex items-center w-fit px-3 py-1.5 rounded-full border border-myc-deep/30 bg-myc-deep/5 text-xs sm:text-sm text-myc-deep hover:bg-myc-deep hover:text-white hover:border-myc-deep shadow-sm transition"
            >
                <span class="mr-1 text-base leading-none">←</span>
                <span class="font-semibold">返回 MYC 场地总览</span>
            </a>

            <div>
                <h1 class="text-3xl font-extrabold text-gray-900 mb-1">
                    多用途礼堂场地预订
                </h1>
                <p class="text-gray-600 text-sm sm:text-base">
                    所有球类在不同场地不冲突。匹克球限 2 个场地，超出需排 Waiting List。
                </p>
            </div>
        </div>

        <!-- 登录状态 + 会员身份 -->
        <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-6 flex flex-col md:flex-row justify-between items-start md:items-center">
            <div class="flex-1">
                <div id="auth-status" class="text-gray-700 font-medium mb-1">
                    认证中...
                </div>
                <p id="membership-status" class="text-sm text-gray-600">
                    会员身份：检查中...
                </p>
                <p id="opening-hours-display" class="text-xs text-gray-500 mt-1">
                    今日营业时间：加载中...
                </p>
            </div>
        </div>

        <!-- 日期 + 上下天 -->
        <div class="flex items-center justify-between gap-4 mb-8">
            <div class="w-full md:w-1/3">
                <label for="date-select" class="block text-sm font-medium text-gray-700 mb-1">选择日期</label>
                <input
                    type="date"
                    id="date-select"
                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out bg-white text-base"
                />
            </div>

            <div class="w-full md:w-2/3 flex gap-2 pt-6 justify-end">
                <button
                    id="prev-day"
                    class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow hover:bg-gray-300 transition duration-150 ease-in-out"
                    aria-label="上一天"
                >
                    &lt; 上一天
                </button>
                <button
                    id="next-day"
                    class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow hover:bg-gray-300 transition duration-150 ease-in-out"
                    aria-label="下一天"
                >
                    下一天 &gt;
                </button>
            </div>
        </div>

        <!-- 运动 / 场地数 / 时长 / 预订按钮 -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 bg-gray-100 p-4 rounded-xl shadow-inner mb-6">
            <div>
                <label for="sport-select" class="block text-sm font-medium text-gray-700 mb-1">运动</label>
                <select id="sport-select" class="w-full p-2 border border-gray-300 rounded-lg"></select>
            </div>

            <div>
                <label id="courts-count-label" for="courts-count-select" class="block text-sm font-medium text-gray-700 mb-1">场地数</label>
                <select id="courts-count-select" class="w-full p-2 border border-gray-300 rounded-lg"></select>
            </div>

            <div>
                <label for="start-time-select" class="block text-sm font-medium text-gray-700 mb-1">开始时间</label>
                <select id="start-time-select" class="w-full p-2 border border-gray-300 rounded-lg"></select>
            </div>

            <div>
                <label for="duration-select" class="block text-sm font-medium text-gray-700 mb-1">时长 (小时)</label>
                <select id="duration-select" class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="1">1 小时</option>
                    <option value="2">2 小时</option>
                    <option value="3">3 小时</option>
                    <option value="4">4 小时</option>
                    <option value="5">5 小时</option>
                </select>
            </div>

            <div class="col-span-2 md:col-span-1 flex items-end">
                <button
                    id="book-button"
                    class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-150 ease-in-out disabled:bg-indigo-300"
                >
                    立即预订
                </button>
            </div>
        </div>

        <!-- 场地矩阵 -->
        <h2 id="current-date-display" class="text-xl font-semibold text-gray-800 mb-4">
            场地实时可用性 (Court A–D)
        </h2>

        <div class="table-container">
            <div id="slots-table" class="grid" style="grid-template-columns: 110px repeat(4, minmax(0, 1fr));">
                <div class="grid-header rounded-tl-xl">时段</div>
                <div class="grid-header">Court A</div>
                <div class="grid-header">Court B</div>
                <div class="grid-header">Court C</div>
                <div class="grid-header rounded-tr-xl">Court D</div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading-indicator" class="text-center text-gray-500 mt-4 hidden">
            <svg
                class="animate-spin h-5 w-5 text-indigo-500 inline-block mr-2"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
            >
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
            </svg>
            操作处理中...
        </div>
    </div>

    <!-- 预订 / 候补 Modal -->
    <div id="booking-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-4 transform transition-all">
            <h3 class="text-2xl font-bold text-myc-deep mb-4 border-b pb-2">确认预订</h3>
            <div id="modal-body" class="space-y-3 text-gray-700 text-sm"></div>
            <div class="flex justify-end space-x-4 mt-6">
                <button
                    id="close-modal-btn"
                    class="px-4 py-2 bg-gray-300 text-gray-800 rounded-xl hover:bg-gray-400 transition"
                >
                    取消
                </button>
                <button
                    id="confirm-booking-btn"
                    class="px-4 py-2 bg-myc-green text-white rounded-xl shadow-md hover:bg-myc-deep transition"
                >
                    确认预订
                </button>
            </div>
        </div>
    </div>
</body>
</html>