<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>付款确认 - MYC 场地预订</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'myc-deep': '#5B217D',
            'myc-green': '#68b92b',
            'myc-yellow': '#FFC107',
            'myc-offwhite': '#F9F7F3',
            'myc-dark-footer': '#3A1054',
          },
        },
      },
    };
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-myc-offwhite">
  
  <!-- Loading Overlay (用于退回操作时的等待提示) -->
  <div id="loading-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-2xl flex items-center space-x-3">
        <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-myc-deep" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-gray-700 font-medium">正在取消预订并释放场地...</span>
    </div>
  </div>

  <div class="w-full max-w-3xl bg-white rounded-3xl shadow-2xl p-6 md:p-8 space-y-6">
    <!-- 顶部 -->
    <div class="flex items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold text-myc-deep">付款确认</h1>
        <p class="text-sm text-gray-500 mt-1">
          请根据以下预订资料进行转账，并上传转账截图作为凭证。
        </p>
      </div>
      <a
        href="myc_homepage.html"
        class="text-xs md:text-sm px-3 py-1.5 rounded-full border border-myc-deep/40 text-myc-deep hover:bg-myc-deep hover:text-white transition"
      >
        ← 回到首页
      </a>
    </div>

    <!-- 如果没有预订资料 -->
    <div id="no-booking" class="hidden p-4 rounded-xl bg-yellow-50 border border-yellow-200 text-yellow-800 text-sm">
      找不到刚刚的预订资料。可能是：
      <ul class="list-disc pl-4 mt-1">
        <li>你直接打开了这个页面（不是从预订页跳过来的）；</li>
        <li>浏览器清除了纪录。</li>
      </ul>
      <p class="mt-2">
        请回到
        <a href="myc_booking.html" class="underline text-myc-deep font-semibold">场地预订页面</a>
        重新选择场地。
      </p>
    </div>

    <!-- 有预订资料时显示 -->
    <div id="booking-wrapper" class="hidden space-y-6">
      <!-- 预订摘要 -->
      <section class="grid md:grid-cols-2 gap-4">
        <div class="p-4 rounded-2xl bg-indigo-50 border border-indigo-100">
          <h2 class="text-sm font-semibold text-myc-deep mb-2">预订资料</h2>
          <div class="space-y-1 text-sm text-gray-700" id="booking-summary">
            <!-- 由 JS 填入 -->
          </div>
        </div>

        <!-- 金额与会员状态 -->
        <div class="p-4 rounded-2xl bg-green-50 border border-green-100">
          <h2 class="text-sm font-semibold text-myc-deep mb-2">金额与身份</h2>
          <p class="text-sm text-gray-700">
            <span class="font-medium">姓名：</span><span id="user-name"></span>
          </p>
          <p class="text-sm text-gray-700">
            <span class="font-medium">Email：</span><span id="user-email"></span>
          </p>
          <p class="text-sm text-gray-700">
            <span class="font-medium">身份：</span><span id="membership-label"></span>
          </p>
          <p class="mt-3 text-base text-myc-dark-footer">
            <span class="font-semibold">每小时费用：</span>
            RM <span id="hourly-rate" class="font-bold"></span>
          </p>
          <p class="text-xl md:text-2xl font-extrabold text-myc-deep mt-1">
            应付总额：RM <span id="total-amount"></span>
          </p>
          <p class="mt-2 text-xs text-gray-500">
            * 金额已根据会员/非会员价、场地数量与时长自动计算。
          </p>
        </div>
      </section>

      <!-- 付款 QR -->
      <section class="grid md:grid-cols-2 gap-6 items-center">
        <div class="space-y-2">
          <h2 class="text-sm font-semibold text-myc-deep">步骤一：扫描 QR 转账</h2>
          <p class="text-sm text-gray-600">
            请使用网银 / eWallet 扫描右侧的 QR Code 完成转账。
          </p>
          <ul class="text-sm text-gray-600 list-disc pl-4 mt-2 space-y-1">
            <li>收款方：MY Centre Sibu</li>
            <li>用途备注：<span class="font-semibold">场地预订 + 你的姓名</span></li>
            <li>金额：<span class="font-semibold">以上方「应付总额」为准</span></li>
          </ul>
        </div>
        <div class="flex justify-center">
          <!-- 这里换成你的真正 QR 图片路径 -->
          <img
            src="Image/Payment_QRDuitnow.jpeg"
            alt="付款 QR Code"
            class="w-60 h-60 md:w-52 md:h-52 rounded-xl shadow-lg border border-gray-200 object-contain bg-white"
            onerror="this.src='https://placehold.co/200x200?text=MYC+QR';"
          />
        </div>
      </section>

      <!-- 上传凭证 -->
      <section class="space-y-3">
        <h2 class="text-sm font-semibold text-myc-deep">步骤二：上传转账截图</h2>
        <p class="text-sm text-gray-600">
          请上传你的转账证明截图。工作人员确认后，你的预订才算完成。
        </p>

        <div class="grid md:grid-cols-[2fr_3fr] gap-4 items-start">
          <div>
            <label
              for="receipt-file"
              class="block text-xs font-medium text-gray-700 mb-1"
            >
              选择图片档（jpg / png）
            </label>
            <input
              id="receipt-file"
              type="file"
              accept="image/*"
              class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-myc-deep file:text-white hover:file:bg-myc-dark-footer"
            />
            <p class="mt-1 text-xs text-gray-500">
              目前仅做画面预览，尚未连到云端储存。
            </p>
          </div>
          <div>
            <p class="text-xs font-medium text-gray-700 mb-1">图片预览：</p>
            <div
              id="receipt-preview"
              class="w-full h-40 md:h-52 rounded-xl border border-dashed border-gray-300 flex items-center justify-center text-xs text-gray-400 bg-gray-50"
            >
              尚未选择档案
            </div>
          </div>
        </div>
      </section>

      <!-- 最底部按钮 -->
      <div class="flex flex-col sm:flex-row sm:justify-between gap-3 pt-4 border-t border-gray-200">
        <p class="text-xs text-gray-500">
          上传截图后，请保留转账纪录。若有任何问题，可联络 MYC 同工。
        </p>
        <div class="flex gap-2 justify-end">
          <button
              id="back-booking-button"
              type="button"
              class="px-4 py-2 rounded-full border border-gray-300 text-sm text-gray-700 hover:bg-gray-100 hover:text-red-600 transition"
          >
            返回修改预订
          </button>

          <button
            id="finish-button"
            class="px-4 py-2 rounded-full bg-myc-green text-white text-sm font-semibold hover:bg-myc-deep transition"
          >
            我已完成付款
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
  // 必须使用 Realtime Database 的 import，配合你 uploaded file 的逻辑
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js"; // 新增 Auth 导入

  const firebaseConfig = {
    apiKey: "AIzaSyDLY-Nd3exPFG2ExPil-ko_dFn9Zz3E-oE",
    authDomain: "myc-booking.firebaseapp.com",
    databaseURL: "https://myc-booking-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "myc-booking",
    storageBucket: "myc-booking.firebasestorage.app",
    messagingSenderId: "398699322309",
    appId: "1:398699322309:web:2a176336e76eda30c009ac",
    measurementId: "G-MET5E50WKS",
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const auth = getAuth(app); // 初始化 Auth

  let latestBooking = null;  // 全局存一份，给「返回修改」时用

  // 1. 页面加载：从 LocalStorage 读取预订信息
  function loadBooking() {
    const raw = localStorage.getItem('myc_latest_booking');
    if (!raw) {
      document.getElementById('no-booking').classList.remove('hidden');
      return;
    }

    try {
      latestBooking = JSON.parse(raw);
    } catch (e) {
      console.error('解析 booking 资料失败', e);
      document.getElementById('no-booking').classList.remove('hidden');
      return;
    }

    document.getElementById('booking-wrapper').classList.remove('hidden');

    const { sport, date, startTime, durationHours, courts, totalAmount, hourlyRate, isMember, userName, email, reservationId } = latestBooking;

    const summaryEl = document.getElementById('booking-summary');
    summaryEl.innerHTML = `
      <p><span class="font-medium">运动：</span>${sport}</p>
      <p><span class="font-medium">日期：</span>${date}</p>
      <p><span class="font-medium">时间：</span>${startTime} 开始 · ${durationHours} 小时</p>
      <p><span class="font-medium">场地：</span>${courts && courts.length ? courts.join('，') : '—'}</p>
      <p><span class="font-medium">预订编号：</span>${reservationId || '—'}</p>
    `;

    document.getElementById('user-name').textContent  = userName || '—';
    document.getElementById('user-email').textContent = email || '—';
    document.getElementById('membership-label').textContent = isMember ? '会员' : '非会员';

    document.getElementById('hourly-rate').textContent  = (hourlyRate  || 0).toFixed(2);
    document.getElementById('total-amount').textContent = (totalAmount || 0).toFixed(2);
  }

  // 2. 上传图片预览
  document.getElementById('receipt-file').addEventListener('change', (e) => {
    const file = e.target.files[0];
    const preview = document.getElementById('receipt-preview');

    if (!file) {
      preview.textContent = '尚未选择档案';
      preview.style.backgroundImage = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = (ev) => {
      preview.style.backgroundImage = `url('${ev.target.result}')`;
      preview.style.backgroundSize = 'contain';
      preview.style.backgroundRepeat = 'no-repeat';
      preview.style.backgroundPosition = 'center';
      preview.textContent = '';
    };
    reader.readAsDataURL(file);
  });

  // 3. 确认付款
  document.getElementById('finish-button').addEventListener('click', async () => {
    const fileInput = document.getElementById('receipt-file');

    if (!fileInput.files || fileInput.files.length === 0) {
      alert('请先上传转账截图，再点击「我已完成付款」。');
      fileInput.focus();
      return;
    }

    // 这里目前只做前端确认 + 跳回首页
    alert('系统已记录你的预订与付款截图。\n同工核对后，若有问题会再联络你。');
    // 成功后，清除本地记录，避免用户按“上一页”又触发逻辑
    localStorage.removeItem('myc_latest_booking');
    window.location.href = 'myc_homepage.html';
  });

  // ==========================================================
  // 核心更改：返回修改预订 = 删除数据库记录 (Cancel Booking)
  // ==========================================================
  async function cancelCurrentBookingAndGoBack() {
    // 1. 如果没有本地记录，直接回预订页
    if (!latestBooking) {
      window.location.href = 'myc_booking.html';
      return;
    }

    // 显示 Loading，防止用户以为没反应
    document.getElementById('loading-overlay').classList.remove('hidden');

    const slotKeys = latestBooking.slotKeys;
    const reservationId = latestBooking.reservationId;

    // 如果资料不完整，直接清除并跳回
    if ((!slotKeys || slotKeys.length === 0) && !reservationId) {
      localStorage.removeItem('myc_latest_booking');
      window.location.href = 'myc_booking.html';
      return;
    }

    try {
      // 在尝试删除前，先确保用户是登录状态（某些规则需要 Auth）
      // 这里做一个简单的检查，如果 auth.currentUser 为 null，可能会导致 Permission Denied
      if (!auth.currentUser) {
         console.warn("当前似乎未登录，删除操作可能会因为权限不足而失败");
      }

      const updates = {};
      
      // A. 删除场地占用格子 (auditorium_court_slots)
      // 将路径设为 null 等同于删除该节点，这样 table 上的时间就会变回空白
      if (slotKeys && Array.isArray(slotKeys)) {
        slotKeys.forEach((key) => {
          updates[`auditorium_court_slots/${key}`] = null;
        });
      }

      // B. 删除预订详情 (auditorium_reservations)
      // 保持数据库整洁，避免产生幽灵订单
      if (reservationId) {
        updates[`auditorium_reservations/${reservationId}`] = null;
      }

      // C. 执行一次性原子更新 (Atomic Update)
      // 使用 ref(db) 作为根路径，然后更新具体的子路径
      await update(ref(db), updates);

      console.log('预订已成功取消，时间段已释放。');

    } catch (e) {
      // 捕获详细错误
      console.error('Firebase 取消预订失败:', e);
      console.error('错误代码:', e.code);
      console.error('错误信息:', e.message);

      let errorMsg = '取消过程中出现问题，请联系管理员确认场地是否已释放。';
      
      if (e.code === 'PERMISSION_DENIED') {
        errorMsg = '权限不足：无法删除预订。可能是登录已过期或系统权限限制。';
      } else if (e.code === 'NETWORK_ERROR') {
         errorMsg = '网络连接不稳定，无法连接到数据库。';
      }

      // 即使数据库删除失败，也提醒用户，然后继续清除本地缓存
      // 这里的 alert 用于调试/告知用户，之后还是会强制跳转
      alert(errorMsg + '\n\n系统将尝试带您返回预订页面。');
      
    } finally {
      // 无论成功与否，都要清除本地记录并带用户回到预订页
      // 这样用户至少不会被“卡死”在这个页面
      localStorage.removeItem('myc_latest_booking');
      window.location.href = 'myc_booking.html';
    }
  }

  // 绑定事件
  document.getElementById('back-booking-button').addEventListener('click', cancelCurrentBookingAndGoBack);

  // 初始化
  // 简单的 Auth 状态监听，确保 SDK 初始化正确
  onAuthStateChanged(auth, (user) => {
      if (user) {
          console.log("Payment Page: 用户已登录", user.uid);
      } else {
          console.log("Payment Page: 用户未登录 (可能是导致 Permission Denied 的原因)");
      }
  });

  loadBooking();
</script>

</body>
</html>